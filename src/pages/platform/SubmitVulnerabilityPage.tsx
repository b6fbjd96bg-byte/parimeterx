import { useState, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { 
  Bug, 
  Upload, 
  X,
  FileText,
  Image,
  Video,
  AlertTriangle
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import PlatformLayout from '@/components/platform/PlatformLayout';
import RoleGuard from '@/components/platform/RoleGuard';
import { usePrograms } from '@/hooks/usePrograms';
import { useVulnerabilityReports } from '@/hooks/useVulnerabilityReports';
import { useToast } from '@/hooks/use-toast';
import { CWE_CATEGORIES, OWASP_CATEGORIES, VulnerabilitySeverity } from '@/types/platform';
import { cn } from '@/lib/utils';

const SubmitVulnerabilityPage = () => {
  const navigate = useNavigate();
  const { programs } = usePrograms();
  const { createReport, uploadAttachment } = useVulnerabilityReports();
  const { toast } = useToast();
  const fileInputRef = useRef<HTMLInputElement>(null);

  const [loading, setLoading] = useState(false);
  const [files, setFiles] = useState<File[]>([]);
  const [formData, setFormData] = useState({
    program_id: '',
    title: '',
    severity: '' as VulnerabilitySeverity | '',
    cwe_id: '',
    owasp_category: '',
    affected_endpoint: '',
    steps_to_reproduce: '',
    proof_of_concept: '',
    impact: '',
    remediation: '',
    cvss_score: '',
  });

  // Filter to only show active programs the pentester is assigned to
  const assignedPrograms = programs.filter(p => p.status === 'active');

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      const newFiles = Array.from(e.target.files);
      setFiles(prev => [...prev, ...newFiles]);
    }
  };

  const removeFile = (index: number) => {
    setFiles(prev => prev.filter((_, i) => i !== index));
  };

  const getFileIcon = (type: string) => {
    if (type.startsWith('image/')) return <Image className="w-4 h-4" />;
    if (type.startsWith('video/')) return <Video className="w-4 h-4" />;
    return <FileText className="w-4 h-4" />;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!formData.program_id || !formData.title || !formData.severity) {
      toast({ 
        title: 'Validation Error', 
        description: 'Please fill in all required fields', 
        variant: 'destructive' 
      });
      return;
    }

    setLoading(true);
    try {
      const report = await createReport({
        program_id: formData.program_id,
        title: formData.title,
        severity: formData.severity as VulnerabilitySeverity,
        cwe_id: formData.cwe_id || null,
        owasp_category: formData.owasp_category || null,
        affected_endpoint: formData.affected_endpoint || null,
        steps_to_reproduce: formData.steps_to_reproduce || null,
        proof_of_concept: formData.proof_of_concept || null,
        impact: formData.impact || null,
        remediation: formData.remediation || null,
        cvss_score: formData.cvss_score ? parseFloat(formData.cvss_score) : null,
      });

      // Upload attachments
      for (const file of files) {
        try {
          await uploadAttachment(report.id, file);
        } catch (err) {
          console.error('Failed to upload file:', file.name, err);
        }
      }

      toast({ title: 'Success', description: 'Vulnerability report submitted successfully' });
      navigate('/platform/vulnerabilities');
    } catch (err) {
      toast({ 
        title: 'Error', 
        description: err instanceof Error ? err.message : 'Failed to submit report', 
        variant: 'destructive' 
      });
    } finally {
      setLoading(false);
    }
  };

  const severities: VulnerabilitySeverity[] = ['critical', 'high', 'medium', 'low', 'informational'];

  return (
    <RoleGuard allowedRoles={['pentester']}>
      <PlatformLayout
        title="Submit Vulnerability"
        subtitle="Report a security finding"
      >
        <form onSubmit={handleSubmit}>
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Main Form */}
            <div className="lg:col-span-2 space-y-6">
              {/* Basic Info */}
              <Card className="bg-card/80 backdrop-blur-sm border-border/50">
                <CardHeader>
                  <CardTitle className="text-lg flex items-center gap-2">
                    <Bug className="w-5 h-5 text-primary" />
                    Basic Information
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <Label htmlFor="program">Program *</Label>
                    <Select
                      value={formData.program_id}
                      onValueChange={(value) => setFormData({ ...formData, program_id: value })}
                    >
                      <SelectTrigger className="mt-2">
                        <SelectValue placeholder="Select a program" />
                      </SelectTrigger>
                      <SelectContent>
                        {assignedPrograms.length === 0 ? (
                          <SelectItem value="none" disabled>No programs available</SelectItem>
                        ) : (
                          assignedPrograms.map((program) => (
                            <SelectItem key={program.id} value={program.id}>
                              {program.name}
                            </SelectItem>
                          ))
                        )}
                      </SelectContent>
                    </Select>
                  </div>

                  <div>
                    <Label htmlFor="title">Title *</Label>
                    <Input
                      id="title"
                      value={formData.title}
                      onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                      placeholder="e.g., Stored XSS in User Profile"
                      className="mt-2"
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="severity">Severity *</Label>
                      <Select
                        value={formData.severity}
                        onValueChange={(value) => setFormData({ ...formData, severity: value as VulnerabilitySeverity })}
                      >
                        <SelectTrigger className="mt-2">
                          <SelectValue placeholder="Select severity" />
                        </SelectTrigger>
                        <SelectContent>
                          {severities.map((s) => (
                            <SelectItem key={s} value={s} className="capitalize">{s}</SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>

                    <div>
                      <Label htmlFor="cvss">CVSS Score</Label>
                      <Input
                        id="cvss"
                        type="number"
                        step="0.1"
                        min="0"
                        max="10"
                        value={formData.cvss_score}
                        onChange={(e) => setFormData({ ...formData, cvss_score: e.target.value })}
                        placeholder="e.g., 7.5"
                        className="mt-2"
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="cwe">CWE ID</Label>
                      <Select
                        value={formData.cwe_id}
                        onValueChange={(value) => setFormData({ ...formData, cwe_id: value })}
                      >
                        <SelectTrigger className="mt-2">
                          <SelectValue placeholder="Select CWE" />
                        </SelectTrigger>
                        <SelectContent>
                          {CWE_CATEGORIES.map((cwe) => (
                            <SelectItem key={cwe.id} value={cwe.id}>
                              {cwe.id} - {cwe.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>

                    <div>
                      <Label htmlFor="owasp">OWASP Category</Label>
                      <Select
                        value={formData.owasp_category}
                        onValueChange={(value) => setFormData({ ...formData, owasp_category: value })}
                      >
                        <SelectTrigger className="mt-2">
                          <SelectValue placeholder="Select OWASP" />
                        </SelectTrigger>
                        <SelectContent>
                          {OWASP_CATEGORIES.map((owasp) => (
                            <SelectItem key={owasp.id} value={owasp.id}>
                              {owasp.id} - {owasp.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>
                  </div>

                  <div>
                    <Label htmlFor="endpoint">Affected Endpoint</Label>
                    <Input
                      id="endpoint"
                      value={formData.affected_endpoint}
                      onChange={(e) => setFormData({ ...formData, affected_endpoint: e.target.value })}
                      placeholder="e.g., /api/v1/users/profile"
                      className="mt-2"
                    />
                  </div>
                </CardContent>
              </Card>

              {/* Details */}
              <Card className="bg-card/80 backdrop-blur-sm border-border/50">
                <CardHeader>
                  <CardTitle className="text-lg">Vulnerability Details</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <Label htmlFor="steps">Steps to Reproduce</Label>
                    <Textarea
                      id="steps"
                      value={formData.steps_to_reproduce}
                      onChange={(e) => setFormData({ ...formData, steps_to_reproduce: e.target.value })}
                      placeholder="1. Navigate to...
2. Enter payload...
3. Click submit..."
                      rows={6}
                      className="mt-2 font-mono text-sm"
                    />
                  </div>

                  <div>
                    <Label htmlFor="poc">Proof of Concept</Label>
                    <Textarea
                      id="poc"
                      value={formData.proof_of_concept}
                      onChange={(e) => setFormData({ ...formData, proof_of_concept: e.target.value })}
                      placeholder="Technical details, payloads, requests, etc..."
                      rows={6}
                      className="mt-2 font-mono text-sm"
                    />
                  </div>

                  <div>
                    <Label htmlFor="impact">Impact</Label>
                    <Textarea
                      id="impact"
                      value={formData.impact}
                      onChange={(e) => setFormData({ ...formData, impact: e.target.value })}
                      placeholder="Describe the potential impact of this vulnerability..."
                      rows={4}
                      className="mt-2"
                    />
                  </div>

                  <div>
                    <Label htmlFor="remediation">Remediation Recommendation</Label>
                    <Textarea
                      id="remediation"
                      value={formData.remediation}
                      onChange={(e) => setFormData({ ...formData, remediation: e.target.value })}
                      placeholder="Suggested fix or mitigation..."
                      rows={4}
                      className="mt-2"
                    />
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Sidebar */}
            <div className="space-y-6">
              {/* Attachments */}
              <Card className="bg-card/80 backdrop-blur-sm border-border/50">
                <CardHeader>
                  <CardTitle className="text-lg flex items-center gap-2">
                    <Upload className="w-5 h-5 text-primary" />
                    Attachments
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <input
                    ref={fileInputRef}
                    type="file"
                    multiple
                    accept="image/*,video/*,application/pdf,text/plain"
                    onChange={handleFileSelect}
                    className="hidden"
                  />
                  
                  <button
                    type="button"
                    onClick={() => fileInputRef.current?.click()}
                    className="w-full border-2 border-dashed border-border rounded-lg p-8 text-center hover:border-primary/50 transition-colors"
                  >
                    <Upload className="w-8 h-8 mx-auto mb-2 text-muted-foreground" />
                    <p className="text-sm text-muted-foreground">
                      Click to upload screenshots, videos, or files
                    </p>
                  </button>

                  {files.length > 0 && (
                    <div className="mt-4 space-y-2">
                      {files.map((file, index) => (
                        <div
                          key={index}
                          className="flex items-center justify-between p-2 rounded bg-muted/50"
                        >
                          <div className="flex items-center gap-2 truncate">
                            {getFileIcon(file.type)}
                            <span className="text-sm truncate">{file.name}</span>
                          </div>
                          <Button
                            type="button"
                            variant="ghost"
                            size="icon"
                            onClick={() => removeFile(index)}
                            className="shrink-0"
                          >
                            <X className="w-4 h-4" />
                          </Button>
                        </div>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Submit */}
              <Card className="bg-card/80 backdrop-blur-sm border-border/50">
                <CardContent className="pt-6">
                  <Button
                    type="submit"
                    variant="cyber"
                    size="lg"
                    className="w-full"
                    disabled={loading}
                  >
                    {loading ? 'Submitting...' : 'Submit Vulnerability'}
                  </Button>
                  <p className="text-xs text-muted-foreground text-center mt-4">
                    <AlertTriangle className="w-3 h-3 inline mr-1" />
                    Make sure to follow the program's rules of engagement
                  </p>
                </CardContent>
              </Card>
            </div>
          </div>
        </form>
      </PlatformLayout>
    </RoleGuard>
  );
};

export default SubmitVulnerabilityPage;

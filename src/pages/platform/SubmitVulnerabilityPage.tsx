import { useState, useRef } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { Bug, Upload, X, ChevronRight, ChevronLeft, Check, FileText, Image, Video, AlertTriangle, Zap } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import PlatformLayout from '@/components/platform/PlatformLayout';
import RoleGuard from '@/components/platform/RoleGuard';
import { usePrograms } from '@/hooks/usePrograms';
import { useVulnerabilityReports } from '@/hooks/useVulnerabilityReports';
import { useToast } from '@/hooks/use-toast';
import { CWE_CATEGORIES, OWASP_CATEGORIES, VulnerabilitySeverity, SEVERITY_COLORS } from '@/types/platform';
import { cn } from '@/lib/utils';

const SEVERITY_TEMPLATES: Record<string, { cwe: string; owasp: string; impact: string }> = {
  'XSS': { cwe: 'CWE-79', owasp: 'A03', impact: 'An attacker can execute arbitrary JavaScript in the context of a victim user\'s browser session.' },
  'SQL Injection': { cwe: 'CWE-89', owasp: 'A03', impact: 'An attacker can manipulate database queries to read, modify, or delete data.' },
  'SSRF': { cwe: 'CWE-918', owasp: 'A10', impact: 'An attacker can make the server perform requests to internal resources.' },
  'IDOR': { cwe: 'CWE-639', owasp: 'A01', impact: 'An attacker can access or modify resources belonging to other users.' },
  'Auth Bypass': { cwe: 'CWE-287', owasp: 'A07', impact: 'An attacker can bypass authentication to gain unauthorized access.' },
  'File Upload': { cwe: 'CWE-434', owasp: 'A05', impact: 'An attacker can upload malicious files leading to remote code execution.' },
};

const SubmitVulnerabilityPage = () => {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const { programs } = usePrograms();
  const { createReport, uploadAttachment } = useVulnerabilityReports();
  const { toast } = useToast();
  const fileInputRef = useRef<HTMLInputElement>(null);

  const [step, setStep] = useState(1);
  const [loading, setLoading] = useState(false);
  const [files, setFiles] = useState<File[]>([]);
  const [formData, setFormData] = useState({
    program_id: searchParams.get('program') || '',
    title: '',
    severity: '' as VulnerabilitySeverity | '',
    cwe_id: '',
    owasp_category: '',
    affected_endpoint: '',
    steps_to_reproduce: '',
    proof_of_concept: '',
    impact: '',
    remediation: '',
    cvss_score: '',
  });

  const assignedPrograms = programs.filter(p => p.status === 'active');
  const severities: VulnerabilitySeverity[] = ['critical', 'high', 'medium', 'low', 'informational'];

  const applyTemplate = (templateName: string) => {
    const tmpl = SEVERITY_TEMPLATES[templateName];
    if (tmpl) {
      setFormData(prev => ({ ...prev, cwe_id: tmpl.cwe, owasp_category: tmpl.owasp, impact: tmpl.impact, title: prev.title || templateName }));
      toast({ title: 'Template Applied', description: `${templateName} template auto-filled` });
    }
  };

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) setFiles(prev => [...prev, ...Array.from(e.target.files!)]);
  };

  const removeFile = (index: number) => setFiles(prev => prev.filter((_, i) => i !== index));

  const getFileIcon = (type: string) => {
    if (type.startsWith('image/')) return <Image className="w-4 h-4" />;
    if (type.startsWith('video/')) return <Video className="w-4 h-4" />;
    return <FileText className="w-4 h-4" />;
  };

  const handleSubmit = async () => {
    if (!formData.program_id || !formData.title || !formData.severity) {
      toast({ title: 'Validation Error', description: 'Please fill in all required fields', variant: 'destructive' });
      return;
    }
    setLoading(true);
    try {
      const report = await createReport({
        program_id: formData.program_id,
        title: formData.title,
        severity: formData.severity as VulnerabilitySeverity,
        cwe_id: formData.cwe_id || null,
        owasp_category: formData.owasp_category || null,
        affected_endpoint: formData.affected_endpoint || null,
        steps_to_reproduce: formData.steps_to_reproduce || null,
        proof_of_concept: formData.proof_of_concept || null,
        impact: formData.impact || null,
        remediation: formData.remediation || null,
        cvss_score: formData.cvss_score ? parseFloat(formData.cvss_score) : null,
      });
      for (const file of files) {
        try { await uploadAttachment(report.id, file); } catch (err) { console.error('Upload failed:', err); }
      }
      toast({ title: 'âœ… Submitted!', description: 'Vulnerability report submitted successfully' });
      navigate('/platform/vulnerabilities');
    } catch (err) {
      toast({ title: 'Error', description: err instanceof Error ? err.message : 'Failed to submit', variant: 'destructive' });
    } finally {
      setLoading(false);
    }
  };

  const canProceedStep1 = formData.program_id && formData.title && formData.severity;

  return (
    <RoleGuard allowedRoles={['pentester', 'admin']}>
      <PlatformLayout title="Submit Vulnerability" subtitle="Step-by-step guided submission">
        <Card className="bg-card/80 backdrop-blur-sm border-border/50 max-w-3xl mx-auto">
          <CardContent className="p-6">
            {/* Step Indicator */}
            <div className="flex items-center gap-2 mb-8">
              {[{ n: 1, label: 'Basic Info' }, { n: 2, label: 'Details & PoC' }, { n: 3, label: 'Review & Submit' }].map(({ n, label }) => (
                <div key={n} className="flex items-center gap-2 flex-1">
                  <div className={cn(
                    'w-9 h-9 rounded-full flex items-center justify-center text-sm font-semibold border transition-all',
                    step === n ? 'bg-primary text-primary-foreground border-primary' :
                    step > n ? 'bg-primary/20 text-primary border-primary/30' :
                    'bg-muted text-muted-foreground border-border'
                  )}>
                    {step > n ? <Check className="w-4 h-4" /> : n}
                  </div>
                  <span className={cn('text-xs hidden sm:block', step >= n ? 'text-foreground' : 'text-muted-foreground')}>{label}</span>
                  {n < 3 && <div className={cn('flex-1 h-px', step > n ? 'bg-primary' : 'bg-border')} />}
                </div>
              ))}
            </div>

            {/* Step 1 */}
            {step === 1 && (
              <div className="space-y-5">
                <div>
                  <Label className="text-xs text-muted-foreground mb-2 block">Quick Templates</Label>
                  <div className="flex flex-wrap gap-2">
                    {Object.keys(SEVERITY_TEMPLATES).map((name) => (
                      <Button key={name} type="button" variant="outline" size="sm" onClick={() => applyTemplate(name)} className="text-xs">
                        <Zap className="w-3 h-3 mr-1" />{name}
                      </Button>
                    ))}
                  </div>
                </div>

                <div>
                  <Label>Program *</Label>
                  <Select value={formData.program_id} onValueChange={(v) => setFormData({ ...formData, program_id: v })}>
                    <SelectTrigger className="mt-1"><SelectValue placeholder="Select program" /></SelectTrigger>
                    <SelectContent>
                      {assignedPrograms.map((p) => (<SelectItem key={p.id} value={p.id}>{p.name}</SelectItem>))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label>Title *</Label>
                  <Input value={formData.title} onChange={(e) => setFormData({ ...formData, title: e.target.value })} placeholder="e.g., Stored XSS in User Profile" className="mt-1" />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Severity *</Label>
                    <Select value={formData.severity} onValueChange={(v) => setFormData({ ...formData, severity: v as VulnerabilitySeverity })}>
                      <SelectTrigger className="mt-1"><SelectValue placeholder="Select" /></SelectTrigger>
                      <SelectContent>{severities.map(s => <SelectItem key={s} value={s} className="capitalize">{s}</SelectItem>)}</SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label>CVSS Score</Label>
                    <Input type="number" step="0.1" min="0" max="10" value={formData.cvss_score} onChange={(e) => setFormData({ ...formData, cvss_score: e.target.value })} placeholder="0-10" className="mt-1" />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>CWE</Label>
                    <Select value={formData.cwe_id} onValueChange={(v) => setFormData({ ...formData, cwe_id: v })}>
                      <SelectTrigger className="mt-1"><SelectValue placeholder="Select CWE" /></SelectTrigger>
                      <SelectContent>{CWE_CATEGORIES.map(c => <SelectItem key={c.id} value={c.id}>{c.id} - {c.name}</SelectItem>)}</SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label>OWASP</Label>
                    <Select value={formData.owasp_category} onValueChange={(v) => setFormData({ ...formData, owasp_category: v })}>
                      <SelectTrigger className="mt-1"><SelectValue placeholder="Select" /></SelectTrigger>
                      <SelectContent>{OWASP_CATEGORIES.map(o => <SelectItem key={o.id} value={o.id}>{o.id} - {o.name}</SelectItem>)}</SelectContent>
                    </Select>
                  </div>
                </div>

                <div>
                  <Label>Affected Endpoint</Label>
                  <Input value={formData.affected_endpoint} onChange={(e) => setFormData({ ...formData, affected_endpoint: e.target.value })} placeholder="/api/v1/..." className="mt-1" />
                </div>
              </div>
            )}

            {/* Step 2 */}
            {step === 2 && (
              <div className="space-y-5">
                <div>
                  <Label>Steps to Reproduce *</Label>
                  <Textarea value={formData.steps_to_reproduce} onChange={(e) => setFormData({ ...formData, steps_to_reproduce: e.target.value })} placeholder={"1. Navigate to...\n2. Enter payload...\n3. Observe..."} rows={6} className="mt-1 font-mono text-sm" />
                </div>
                <div>
                  <Label>Proof of Concept</Label>
                  <Textarea value={formData.proof_of_concept} onChange={(e) => setFormData({ ...formData, proof_of_concept: e.target.value })} placeholder="Technical details, payloads..." rows={5} className="mt-1 font-mono text-sm" />
                </div>
                <div>
                  <Label>Impact</Label>
                  <Textarea value={formData.impact} onChange={(e) => setFormData({ ...formData, impact: e.target.value })} placeholder="Describe the impact..." rows={3} className="mt-1" />
                </div>
                <div>
                  <Label>Remediation</Label>
                  <Textarea value={formData.remediation} onChange={(e) => setFormData({ ...formData, remediation: e.target.value })} placeholder="Suggested fix..." rows={3} className="mt-1" />
                </div>
                <div>
                  <Label>Attachments</Label>
                  <input ref={fileInputRef} type="file" multiple accept="image/*,video/*,application/pdf,text/plain" onChange={handleFileSelect} className="hidden" />
                  <button type="button" onClick={() => fileInputRef.current?.click()} className="w-full border-2 border-dashed border-border rounded-lg p-4 text-center hover:border-primary/50 transition-colors mt-1">
                    <Upload className="w-6 h-6 mx-auto mb-1 text-muted-foreground" />
                    <p className="text-xs text-muted-foreground">Click to upload screenshots/files</p>
                  </button>
                  {files.length > 0 && (
                    <div className="mt-2 space-y-1">
                      {files.map((file, i) => (
                        <div key={i} className="flex items-center justify-between p-2 rounded bg-muted/50 text-sm">
                          <div className="flex items-center gap-2 truncate">{getFileIcon(file.type)}<span className="truncate">{file.name}</span></div>
                          <Button type="button" variant="ghost" size="icon" onClick={() => removeFile(i)} className="shrink-0 h-6 w-6"><X className="w-3 h-3" /></Button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Step 3: Review */}
            {step === 3 && (
              <div className="space-y-4">
                <div className="rounded-lg border border-border/50 bg-muted/20 p-5 space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="font-medium">{formData.title}</span>
                    {formData.severity && (
                      <Badge className={cn('border capitalize', SEVERITY_COLORS[formData.severity as keyof typeof SEVERITY_COLORS])}>
                        {formData.severity}
                      </Badge>
                    )}
                  </div>
                  <div className="text-sm text-muted-foreground">
                    Program: {assignedPrograms.find(p => p.id === formData.program_id)?.name || 'Unknown'}
                  </div>
                  {formData.cvss_score && <div className="text-sm text-muted-foreground">CVSS: {formData.cvss_score}</div>}
                  {formData.affected_endpoint && <div className="text-sm font-mono text-muted-foreground">{formData.affected_endpoint}</div>}
                  {formData.cwe_id && <div className="text-sm text-muted-foreground">CWE: {formData.cwe_id} | OWASP: {formData.owasp_category || 'N/A'}</div>}
                  {formData.steps_to_reproduce && (
                    <div><span className="text-xs font-medium">Steps:</span><pre className="text-xs text-muted-foreground mt-1 whitespace-pre-wrap">{formData.steps_to_reproduce}</pre></div>
                  )}
                  {formData.impact && (
                    <div><span className="text-xs font-medium">Impact:</span><p className="text-xs text-muted-foreground mt-1">{formData.impact}</p></div>
                  )}
                  {files.length > 0 && <div className="text-xs text-muted-foreground">{files.length} attachment(s)</div>}
                </div>
                <p className="text-xs text-muted-foreground flex items-center gap-1">
                  <AlertTriangle className="w-3 h-3" />
                  Review carefully before submitting.
                </p>
              </div>
            )}

            {/* Navigation */}
            <div className="flex items-center justify-between pt-6 mt-6 border-t border-border">
              {step > 1 ? (
                <Button variant="outline" onClick={() => setStep(step - 1)}>
                  <ChevronLeft className="w-4 h-4 mr-1" />Back
                </Button>
              ) : <div />}
              
              {step < 3 ? (
                <Button variant="cyber" onClick={() => setStep(step + 1)} disabled={step === 1 && !canProceedStep1}>
                  Next<ChevronRight className="w-4 h-4 ml-1" />
                </Button>
              ) : (
                <Button variant="cyber" onClick={handleSubmit} disabled={loading} size="lg">
                  {loading ? 'Submitting...' : 'ðŸš€ Submit Finding'}
                </Button>
              )}
            </div>
          </CardContent>
        </Card>
      </PlatformLayout>
    </RoleGuard>
  );
};

export default SubmitVulnerabilityPage;

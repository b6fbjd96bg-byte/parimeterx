import { useEffect, useState } from "react";
import { Building2, Server, Database, Shield, Lock } from "lucide-react";

const EnterprisePentestAnimation = () => {
  const [activeNode, setActiveNode] = useState(0);
  const [dataPackets, setDataPackets] = useState<{ id: number; from: number; to: number; progress: number }[]>([]);

  useEffect(() => {
    const nodeInterval = setInterval(() => {
      setActiveNode((prev) => (prev + 1) % 5);
    }, 1500);

    const packetInterval = setInterval(() => {
      setDataPackets((prev) => {
        const newPackets = prev
          .map((p) => ({ ...p, progress: p.progress + 5 }))
          .filter((p) => p.progress <= 100);

        if (Math.random() > 0.6) {
          const from = Math.floor(Math.random() * 5);
          const to = (from + 1 + Math.floor(Math.random() * 4)) % 5;
          newPackets.push({ id: Date.now(), from, to, progress: 0 });
        }

        return newPackets;
      });
    }, 100);

    return () => {
      clearInterval(nodeInterval);
      clearInterval(packetInterval);
    };
  }, []);

  const nodes = [
    { x: 50, y: 15, icon: Building2, label: "HQ", secured: activeNode >= 0 },
    { x: 20, y: 40, icon: Server, label: "Server", secured: activeNode >= 1 },
    { x: 80, y: 40, icon: Database, label: "Database", secured: activeNode >= 2 },
    { x: 30, y: 75, icon: Shield, label: "Firewall", secured: activeNode >= 3 },
    { x: 70, y: 75, icon: Lock, label: "Auth", secured: activeNode >= 4 },
  ];

  const connections = [
    [0, 1], [0, 2], [1, 3], [2, 4], [1, 2], [3, 4],
  ];

  return (
    <div className="relative w-full h-[300px] md:h-[400px]">
      <svg className="absolute inset-0 w-full h-full">
        {/* Connection lines */}
        {connections.map(([from, to], index) => {
          const fromNode = nodes[from];
          const toNode = nodes[to];
          const isActive = nodes[from].secured && nodes[to].secured;
          
          return (
            <g key={index}>
              <line
                x1={`${fromNode.x}%`}
                y1={`${fromNode.y}%`}
                x2={`${toNode.x}%`}
                y2={`${toNode.y}%`}
                stroke={isActive ? "hsl(var(--color-green-secure))" : "hsl(var(--border))"}
                strokeWidth="2"
                strokeDasharray={isActive ? "0" : "5,5"}
                className="transition-all duration-500"
              />
              {/* Animated glow for active connections */}
              {isActive && (
                <line
                  x1={`${fromNode.x}%`}
                  y1={`${fromNode.y}%`}
                  x2={`${toNode.x}%`}
                  y2={`${toNode.y}%`}
                  stroke="hsl(var(--color-green-secure))"
                  strokeWidth="4"
                  opacity="0.3"
                  className="animate-pulse"
                />
              )}
            </g>
          );
        })}

        {/* Data packets */}
        {dataPackets.map((packet) => {
          const fromNode = nodes[packet.from];
          const toNode = nodes[packet.to];
          const x = fromNode.x + (toNode.x - fromNode.x) * (packet.progress / 100);
          const y = fromNode.y + (toNode.y - fromNode.y) * (packet.progress / 100);
          
          return (
            <circle
              key={packet.id}
              cx={`${x}%`}
              cy={`${y}%`}
              r="4"
              fill="hsl(var(--color-green-secure))"
              className="animate-pulse"
            />
          );
        })}
      </svg>

      {/* Network nodes */}
      {nodes.map((node, index) => {
        const Icon = node.icon;
        return (
          <div
            key={index}
            className={`absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-500 ${
              node.secured ? "scale-110" : "scale-100"
            }`}
            style={{ left: `${node.x}%`, top: `${node.y}%` }}
          >
            {/* Outer ring */}
            <div
              className={`absolute -inset-4 rounded-full border-2 transition-all duration-500 ${
                node.secured
                  ? "border-[hsl(var(--color-green-secure))] shadow-[0_0_20px_hsl(var(--color-green-secure)/0.5)]"
                  : "border-[hsl(var(--border))]"
              }`}
            >
              {node.secured && (
                <div className="absolute inset-0 rounded-full bg-[hsl(var(--color-green-secure)/0.1)] animate-pulse" />
              )}
            </div>
            
            {/* Node icon */}
            <div
              className={`relative w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-500 ${
                node.secured
                  ? "bg-[hsl(var(--color-green-secure)/0.2)] border-[hsl(var(--color-green-secure))]"
                  : "bg-card/50 border-border"
              } border-2 backdrop-blur-sm`}
            >
              <Icon
                className={`w-6 h-6 transition-colors duration-500 ${
                  node.secured ? "text-[hsl(var(--color-green-secure))]" : "text-muted-foreground"
                }`}
              />
            </div>
            
            {/* Label */}
            <span className="absolute -bottom-6 left-1/2 -translate-x-1/2 text-xs font-medium text-muted-foreground whitespace-nowrap">
              {node.label}
            </span>
          </div>
        );
      })}

      {/* Scanning indicator */}
      <div className="absolute bottom-4 left-4 right-4 h-1 bg-border/50 rounded-full overflow-hidden">
        <div
          className="h-full bg-gradient-to-r from-[hsl(var(--color-green-secure))] to-[hsl(var(--color-green-secure)/0.5)] transition-all duration-300"
          style={{ width: `${(activeNode + 1) * 20}%` }}
        />
      </div>
    </div>
  );
};

export default EnterprisePentestAnimation;

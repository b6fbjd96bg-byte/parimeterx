import { useEffect, useState } from "react";

const NetworkPentestAnimation = () => {
  const [scanProgress, setScanProgress] = useState(0);
  const [activeConnections, setActiveConnections] = useState<Set<string>>(new Set());
  const [packets, setPackets] = useState<{ id: number; from: number; to: number; progress: number; type: string }[]>([]);

  const nodes = [
    { x: 50, y: 10, type: "router", label: "Gateway" },
    { x: 20, y: 35, type: "switch", label: "Switch A" },
    { x: 80, y: 35, type: "switch", label: "Switch B" },
    { x: 10, y: 65, type: "pc", label: "PC-1" },
    { x: 35, y: 65, type: "pc", label: "PC-2" },
    { x: 65, y: 65, type: "server", label: "Server" },
    { x: 90, y: 65, type: "db", label: "DB" },
    { x: 50, y: 90, type: "firewall", label: "Firewall" },
  ];

  const connections = [
    [0, 1], [0, 2], [1, 3], [1, 4], [2, 5], [2, 6], [1, 7], [2, 7],
  ];

  useEffect(() => {
    const scanInterval = setInterval(() => {
      setScanProgress((prev) => (prev >= 100 ? 0 : prev + 1));
    }, 100);

    const connectionInterval = setInterval(() => {
      const newActive = new Set<string>();
      connections.forEach(([from, to], i) => {
        if (Math.random() > 0.5) {
          newActive.add(`${from}-${to}`);
        }
      });
      setActiveConnections(newActive);
    }, 500);

    const packetInterval = setInterval(() => {
      setPackets((prev) => {
        const updated = prev
          .map((p) => ({ ...p, progress: p.progress + 4 }))
          .filter((p) => p.progress <= 100);
        
        if (Math.random() > 0.6 && updated.length < 8) {
          const conn = connections[Math.floor(Math.random() * connections.length)];
          updated.push({
            id: Date.now(),
            from: conn[0],
            to: conn[1],
            progress: 0,
            type: Math.random() > 0.7 ? "attack" : "scan",
          });
        }
        return updated;
      });
    }, 80);

    return () => {
      clearInterval(scanInterval);
      clearInterval(connectionInterval);
      clearInterval(packetInterval);
    };
  }, []);

  const getNodeIcon = (type: string) => {
    switch (type) {
      case "router":
        return (
          <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
            <circle cx="12" cy="12" r="3" />
            <path d="M12 2v4M12 18v4M2 12h4M18 12h4M5.6 5.6l2.8 2.8M15.6 15.6l2.8 2.8M5.6 18.4l2.8-2.8M15.6 8.4l2.8-2.8" stroke="currentColor" strokeWidth="2" fill="none" />
          </svg>
        );
      case "switch":
        return (
          <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
            <rect x="2" y="6" width="20" height="12" rx="2" fill="none" stroke="currentColor" strokeWidth="2" />
            <circle cx="6" cy="12" r="1.5" />
            <circle cx="10" cy="12" r="1.5" />
            <circle cx="14" cy="12" r="1.5" />
            <circle cx="18" cy="12" r="1.5" />
          </svg>
        );
      case "pc":
        return (
          <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
            <rect x="2" y="3" width="20" height="14" rx="2" fill="none" stroke="currentColor" strokeWidth="2" />
            <path d="M8 21h8M12 17v4" stroke="currentColor" strokeWidth="2" />
          </svg>
        );
      case "server":
        return (
          <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
            <rect x="4" y="2" width="16" height="6" rx="1" fill="none" stroke="currentColor" strokeWidth="2" />
            <rect x="4" y="9" width="16" height="6" rx="1" fill="none" stroke="currentColor" strokeWidth="2" />
            <rect x="4" y="16" width="16" height="6" rx="1" fill="none" stroke="currentColor" strokeWidth="2" />
            <circle cx="7" cy="5" r="1" />
            <circle cx="7" cy="12" r="1" />
            <circle cx="7" cy="19" r="1" />
          </svg>
        );
      case "db":
        return (
          <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
            <ellipse cx="12" cy="5" rx="8" ry="3" fill="none" stroke="currentColor" strokeWidth="2" />
            <path d="M20 5v14c0 1.7-3.6 3-8 3s-8-1.3-8-3V5" fill="none" stroke="currentColor" strokeWidth="2" />
            <path d="M20 12c0 1.7-3.6 3-8 3s-8-1.3-8-3" fill="none" stroke="currentColor" strokeWidth="2" />
          </svg>
        );
      case "firewall":
        return (
          <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
            <rect x="3" y="3" width="18" height="18" rx="2" fill="none" stroke="currentColor" strokeWidth="2" />
            <path d="M3 9h18M3 15h18M9 3v18M15 3v18" stroke="currentColor" strokeWidth="1" />
          </svg>
        );
      default:
        return null;
    }
  };

  return (
    <div className="relative w-full h-[300px] md:h-[400px] overflow-hidden">
      {/* Background grid */}
      <div className="absolute inset-0 opacity-5">
        <svg width="100%" height="100%">
          <defs>
            <pattern id="net-grid" width="20" height="20" patternUnits="userSpaceOnUse">
              <path d="M 20 0 L 0 0 0 20" fill="none" stroke="hsl(var(--color-green-secure))" strokeWidth="0.5" />
            </pattern>
          </defs>
          <rect width="100%" height="100%" fill="url(#net-grid)" />
        </svg>
      </div>

      {/* Connection lines */}
      <svg className="absolute inset-0 w-full h-full">
        {connections.map(([from, to], index) => {
          const fromNode = nodes[from];
          const toNode = nodes[to];
          const isActive = activeConnections.has(`${from}-${to}`);
          
          return (
            <g key={index}>
              <line
                x1={`${fromNode.x}%`}
                y1={`${fromNode.y}%`}
                x2={`${toNode.x}%`}
                y2={`${toNode.y}%`}
                stroke={isActive ? "hsl(var(--color-green-secure))" : "hsl(var(--border))"}
                strokeWidth="2"
                className="transition-all duration-300"
              />
              {isActive && (
                <line
                  x1={`${fromNode.x}%`}
                  y1={`${fromNode.y}%`}
                  x2={`${toNode.x}%`}
                  y2={`${toNode.y}%`}
                  stroke="hsl(var(--color-green-secure))"
                  strokeWidth="4"
                  opacity="0.3"
                  className="animate-pulse"
                />
              )}
            </g>
          );
        })}

        {/* Packets */}
        {packets.map((packet) => {
          const fromNode = nodes[packet.from];
          const toNode = nodes[packet.to];
          const x = fromNode.x + (toNode.x - fromNode.x) * (packet.progress / 100);
          const y = fromNode.y + (toNode.y - fromNode.y) * (packet.progress / 100);
          
          return (
            <g key={packet.id}>
              <circle
                cx={`${x}%`}
                cy={`${y}%`}
                r="5"
                fill={packet.type === "attack" ? "hsl(var(--color-red-team))" : "hsl(var(--color-green-secure))"}
                opacity="0.8"
              />
              {packet.type === "scan" && (
                <circle
                  cx={`${x}%`}
                  cy={`${y}%`}
                  r="8"
                  fill="none"
                  stroke="hsl(var(--color-green-secure))"
                  strokeWidth="1"
                  opacity="0.5"
                  className="animate-ping"
                />
              )}
            </g>
          );
        })}
      </svg>

      {/* Network nodes */}
      {nodes.map((node, index) => {
        const isScanned = (scanProgress / 100) * nodes.length > index;
        
        return (
          <div
            key={index}
            className="absolute transform -translate-x-1/2 -translate-y-1/2"
            style={{ left: `${node.x}%`, top: `${node.y}%` }}
          >
            <div
              className={`w-12 h-12 rounded-lg flex items-center justify-center border-2 backdrop-blur-sm transition-all duration-500 ${
                isScanned
                  ? "bg-[hsl(var(--color-green-secure)/0.2)] border-[hsl(var(--color-green-secure))] text-[hsl(var(--color-green-secure))]"
                  : "bg-card/50 border-border text-muted-foreground"
              }`}
            >
              {getNodeIcon(node.type)}
            </div>
            <span className="absolute -bottom-5 left-1/2 -translate-x-1/2 text-[10px] text-muted-foreground whitespace-nowrap">
              {node.label}
            </span>
            
            {isScanned && (
              <div className="absolute -top-1 -right-1 w-4 h-4 rounded-full bg-[hsl(var(--color-green-secure))] flex items-center justify-center">
                <svg className="w-2.5 h-2.5" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3">
                  <polyline points="20 6 9 17 4 12" />
                </svg>
              </div>
            )}
          </div>
        );
      })}

      {/* Scan progress bar */}
      <div className="absolute bottom-4 left-4 right-4">
        <div className="flex justify-between text-xs text-muted-foreground mb-1">
          <span>Network Scan Progress</span>
          <span>{scanProgress}%</span>
        </div>
        <div className="h-2 bg-border/50 rounded-full overflow-hidden">
          <div
            className="h-full bg-[hsl(var(--color-green-secure))] transition-all duration-100"
            style={{ width: `${scanProgress}%` }}
          />
        </div>
      </div>
    </div>
  );
};

export default NetworkPentestAnimation;

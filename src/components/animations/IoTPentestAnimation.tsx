import { useEffect, useState } from "react";
import { Wifi, Bluetooth, Radio } from "lucide-react";

const IoTPentestAnimation = () => {
  const [activeDevice, setActiveDevice] = useState(0);
  const [signals, setSignals] = useState<{ id: number; from: number; angle: number; distance: number }[]>([]);
  const [scanWave, setScanWave] = useState(0);

  const devices = [
    { x: 50, y: 50, type: "hub", label: "Smart Hub", size: "lg" },
    { x: 25, y: 25, type: "camera", label: "Camera", size: "md" },
    { x: 75, y: 25, type: "thermostat", label: "Thermostat", size: "md" },
    { x: 20, y: 70, type: "lock", label: "Smart Lock", size: "md" },
    { x: 80, y: 70, type: "light", label: "Light", size: "sm" },
    { x: 50, y: 85, type: "sensor", label: "Sensor", size: "sm" },
  ];

  useEffect(() => {
    const deviceInterval = setInterval(() => {
      setActiveDevice((prev) => (prev + 1) % devices.length);
    }, 2000);

    const signalInterval = setInterval(() => {
      setSignals((prev) => {
        const updated = prev
          .map((s) => ({ ...s, distance: s.distance + 3 }))
          .filter((s) => s.distance < 100);

        // Add new signals from active device
        if (Math.random() > 0.6) {
          const angle = Math.random() * 360;
          updated.push({
            id: Date.now(),
            from: activeDevice,
            angle,
            distance: 0,
          });
        }

        return updated;
      });
    }, 50);

    const waveInterval = setInterval(() => {
      setScanWave((prev) => (prev >= 100 ? 0 : prev + 2));
    }, 50);

    return () => {
      clearInterval(deviceInterval);
      clearInterval(signalInterval);
      clearInterval(waveInterval);
    };
  }, [activeDevice]);

  const getDeviceIcon = (type: string, isActive: boolean) => {
    const color = isActive ? "text-[hsl(var(--color-green-secure))]" : "text-muted-foreground";
    
    switch (type) {
      case "hub":
        return (
          <svg viewBox="0 0 24 24" className={`w-full h-full ${color}`} fill="currentColor">
            <rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="currentColor" strokeWidth="2" />
            <circle cx="12" cy="12" r="4" fill="currentColor" opacity="0.5" />
            <circle cx="12" cy="12" r="2" fill="currentColor" />
          </svg>
        );
      case "camera":
        return (
          <svg viewBox="0 0 24 24" className={`w-full h-full ${color}`} fill="currentColor">
            <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" strokeWidth="2" />
            <circle cx="12" cy="12" r="4" fill="currentColor" opacity="0.5" />
            <circle cx="12" cy="12" r="2" fill="currentColor" />
          </svg>
        );
      case "thermostat":
        return (
          <svg viewBox="0 0 24 24" className={`w-full h-full ${color}`} fill="currentColor">
            <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" strokeWidth="2" />
            <path d="M12 6v6l4 2" fill="none" stroke="currentColor" strokeWidth="2" />
          </svg>
        );
      case "lock":
        return (
          <svg viewBox="0 0 24 24" className={`w-full h-full ${color}`} fill="currentColor">
            <rect x="5" y="11" width="14" height="10" rx="2" fill="none" stroke="currentColor" strokeWidth="2" />
            <path d="M8 11V7a4 4 0 118 0v4" fill="none" stroke="currentColor" strokeWidth="2" />
          </svg>
        );
      case "light":
        return (
          <svg viewBox="0 0 24 24" className={`w-full h-full ${color}`} fill="currentColor">
            <path d="M9 18h6M12 2v2M4.93 4.93l1.41 1.41M2 12h2M4.93 19.07l1.41-1.41M19.07 4.93l-1.41 1.41M22 12h-2M19.07 19.07l-1.41-1.41" stroke="currentColor" strokeWidth="2" fill="none" />
            <circle cx="12" cy="12" r="4" fill={isActive ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2" />
          </svg>
        );
      case "sensor":
        return (
          <svg viewBox="0 0 24 24" className={`w-full h-full ${color}`} fill="currentColor">
            <rect x="6" y="6" width="12" height="12" rx="2" fill="none" stroke="currentColor" strokeWidth="2" />
            <circle cx="12" cy="12" r="2" fill="currentColor" />
          </svg>
        );
      default:
        return null;
    }
  };

  return (
    <div className="relative w-full h-[300px] md:h-[400px] overflow-hidden">
      {/* Scanning wave */}
      <div
        className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 rounded-full border-2 border-[hsl(var(--color-green-secure))] opacity-30 pointer-events-none"
        style={{
          width: `${scanWave * 4}px`,
          height: `${scanWave * 4}px`,
          transition: "width 0.05s, height 0.05s",
        }}
      />

      {/* Connection lines to hub */}
      <svg className="absolute inset-0 w-full h-full">
        {devices.slice(1).map((device, index) => {
          const hub = devices[0];
          const isConnected = activeDevice === 0 || activeDevice === index + 1;
          
          return (
            <g key={index}>
              <line
                x1={`${hub.x}%`}
                y1={`${hub.y}%`}
                x2={`${device.x}%`}
                y2={`${device.y}%`}
                stroke={isConnected ? "hsl(var(--color-green-secure))" : "hsl(var(--border))"}
                strokeWidth="1"
                strokeDasharray={isConnected ? "0" : "4,4"}
                className="transition-all duration-300"
              />
            </g>
          );
        })}

        {/* Wireless signals */}
        {signals.map((signal) => {
          const device = devices[signal.from];
          const x = device.x + Math.cos((signal.angle * Math.PI) / 180) * (signal.distance / 100) * 30;
          const y = device.y + Math.sin((signal.angle * Math.PI) / 180) * (signal.distance / 100) * 30;
          
          return (
            <circle
              key={signal.id}
              cx={`${x}%`}
              cy={`${y}%`}
              r="3"
              fill="hsl(var(--color-green-secure))"
              opacity={1 - signal.distance / 100}
            />
          );
        })}
      </svg>

      {/* IoT Devices */}
      {devices.map((device, index) => {
        const isActive = activeDevice === index;
        const isSecured = index <= activeDevice;
        const size = device.size === "lg" ? "w-16 h-16" : device.size === "md" ? "w-12 h-12" : "w-10 h-10";
        
        return (
          <div
            key={index}
            className="absolute transform -translate-x-1/2 -translate-y-1/2"
            style={{ left: `${device.x}%`, top: `${device.y}%` }}
          >
            {/* Scanning effect */}
            {isActive && (
              <>
                <div className="absolute -inset-4 rounded-full border-2 border-[hsl(var(--color-green-secure))] animate-ping opacity-50" />
                <div className="absolute -inset-8 rounded-full border border-[hsl(var(--color-green-secure))] animate-ping opacity-25" style={{ animationDelay: "0.2s" }} />
              </>
            )}
            
            {/* Device */}
            <div
              className={`${size} rounded-xl flex items-center justify-center border-2 backdrop-blur-sm transition-all duration-500 p-2 ${
                isSecured
                  ? "bg-[hsl(var(--color-green-secure)/0.2)] border-[hsl(var(--color-green-secure))] shadow-[0_0_15px_hsl(var(--color-green-secure)/0.3)]"
                  : "bg-card/50 border-border"
              } ${isActive ? "scale-110" : "scale-100"}`}
            >
              {getDeviceIcon(device.type, isSecured)}
            </div>
            
            {/* Label */}
            <span className="absolute -bottom-5 left-1/2 -translate-x-1/2 text-[10px] text-muted-foreground whitespace-nowrap">
              {device.label}
            </span>

            {/* Secured badge */}
            {isSecured && (
              <div className="absolute -top-1 -right-1 w-4 h-4 rounded-full bg-[hsl(var(--color-green-secure))] flex items-center justify-center">
                <svg className="w-2.5 h-2.5" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3">
                  <polyline points="20 6 9 17 4 12" />
                </svg>
              </div>
            )}
          </div>
        );
      })}

      {/* Protocol indicators */}
      <div className="absolute top-4 right-4 flex gap-2">
        <div className="flex items-center gap-1 px-2 py-1 rounded bg-card/50 border border-border">
          <Wifi className="w-3 h-3 text-[hsl(var(--color-green-secure))]" />
          <span className="text-[10px] text-muted-foreground">WiFi</span>
        </div>
        <div className="flex items-center gap-1 px-2 py-1 rounded bg-card/50 border border-border">
          <Bluetooth className="w-3 h-3 text-[hsl(var(--color-blue-ai))]" />
          <span className="text-[10px] text-muted-foreground">BLE</span>
        </div>
        <div className="flex items-center gap-1 px-2 py-1 rounded bg-card/50 border border-border">
          <Radio className="w-3 h-3 text-[hsl(var(--color-purple-blockchain))]" />
          <span className="text-[10px] text-muted-foreground">Zigbee</span>
        </div>
      </div>

      {/* Scan status */}
      <div className="absolute bottom-4 left-4 right-4">
        <div className="flex items-center justify-between text-xs text-muted-foreground mb-2">
          <span>IoT Security Scan</span>
          <span>{devices.length} devices</span>
        </div>
        <div className="h-2 bg-border/50 rounded-full overflow-hidden">
          <div
            className="h-full bg-[hsl(var(--color-green-secure))] transition-all duration-300"
            style={{ width: `${((activeDevice + 1) / devices.length) * 100}%` }}
          />
        </div>
      </div>
    </div>
  );
};

export default IoTPentestAnimation;
